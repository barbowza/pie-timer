<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <title>Pie Timer</title>
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
        <link rel="icon" href="favicon.ico" type="image/x-icon" />
        <link rel="stylesheet" href="bulma_darkTheme.css" />
        <script defer src="fontAwesome.v5.7.2.some.js"></script>
    </head>
    <body>
        <!-- Hero Title -->
        <section class="hero is-info is-bold is-small">
            <div class="hero-body">
                <div class="container">
                    <h1 class="title">Pie Timer</h1>
                    <h2 class="subtitle">Practice Like You Mean It!</h2>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="">
                <!-- Main and Secondary panels -->
                <dual-panels id="dual-panels"></dual-panels>
            </div>

            <!-- Vertical Space -->
            <div class="">
                <br />
            </div>

            <!-- Basic Controls - Duration Start/Pause Reset-->
            <div class="">
                <div class="field is-grouped is-grouped-centered">
                    <div class="control">
                        <div class="select is-rounded">
                            <select data-js="select-duration">
                                <option>-- Duration --</option>
                            </select>
                        </div>
                    </div>

                    <p class="control">
                        <btn-start-pause></btn-start-pause>
                    </p>
                    <p class="control">
                        <a class="button is-success btn-reset evt-reset">Reset</a>
                    </p>
                </div>
            </div>
        </section>

        <!-- Duration Picker Modal -->
        <div class="modal is-clipped" data-js="picker-duration">
            <div class="modal-background has-background-primary"></div>
            <div class="modal-content">
                <duration-select></duration-select>
            </div>
        </div>

        <!-- Template SVG Info Icon -->
        <template data-js="template-info-icon">
                <svg id="svg-info-icon" x="0px" y="0px" width="2em" height="2em" viewBox="0 0 330 330" fill="Green">
                        <g>
                            <path
                                d="M165,0C74.019,0,0,74.02,0,165.001C0,255.982,74.019,330,165,330s165-74.018,165-164.999C330,74.02,255.981,0,165,0z
                                    M165,300c-74.44,0-135-60.56-135-134.999C30,90.562,90.56,30,165,30s135,60.562,135,135.001C300,239.44,239.439,300,165,300z"
                            />
                            <path
                                d="M164.998,70c-11.026,0-19.996,8.976-19.996,20.009c0,11.023,8.97,19.991,19.996,19.991
                                    c11.026,0,19.996-8.968,19.996-19.991C184.994,78.976,176.024,70,164.998,70z"
                            />
                            <path
                                d="M165,140c-8.284,0-15,6.716-15,15v90c0,8.284,6.716,15,15,15c8.284,0,15-6.716,15-15v-90C180,146.716,173.284,140,165,140z"
                            />
                        </g>
                    </svg>
                </template>
        <template data-js="template-close-icon">
                <svg id="svg-close-icon" x="0px" y="0px" width="2em" height="2em" viewBox="0 0 612 612" fill="Green">
                        <g>
                            <path
                                d="M420.501,218.79c-0.286-6.942-2.868-13.827-8.186-19.125c-5.297-5.298-12.183-7.898-19.125-8.186
                                   c-7.726-0.325-15.548,2.276-21.438,8.186L306,265.436l-65.752-65.771c-5.909-5.91-13.712-8.492-21.439-8.186
                                   c-6.942,0.287-13.827,2.869-19.125,8.186c-5.297,5.298-7.898,12.183-8.186,19.125c-0.325,7.727,2.276,15.529,8.186,21.439
                                   L265.436,306l-65.752,65.752c-5.91,5.909-8.492,13.713-8.186,21.438c0.287,6.942,2.869,13.828,8.186,19.125
                                   c5.298,5.298,12.183,7.899,19.125,8.186c7.727,0.325,15.53-2.275,21.439-8.186L306,346.564l65.771,65.771
                                   c5.91,5.909,13.713,8.491,21.439,8.186c6.942-0.287,13.827-2.869,19.125-8.186c5.298-5.298,7.898-12.183,8.186-19.125
                                   c0.325-7.727-2.276-15.529-8.186-21.439L346.564,306l65.751-65.752C418.226,234.339,420.826,226.536,420.501,218.79z M306,0
                                   C137.012,0,0,137.012,0,306s137.012,306,306,306s306-137.012,306-306S474.988,0,306,0z M306,554.625
                                   C168.912,554.625,57.375,443.088,57.375,306S168.912,57.375,306,57.375S554.625,168.912,554.625,306S443.088,554.625,306,554.625z"
                            />
                        </g>
                    </svg>
                </template>
    </body>

    <script src="componentDuration.mjs"></script>
    <script src="componentStartPause.mjs"></script>
    <script src="componentPie.mjs"></script>
    <script src="componentDualPanels.mjs"></script>

    <script type="module">
        import { Controls } from './controls.mjs';
        import { Modal } from './modal.mjs';
        import { Timer } from './timer.mjs';
        import { InfoPanel } from './infoPanel.mjs';
        import { Animator } from './animator.mjs';

        // Initialise Dual Panels with icons
        const elDualPanels = document.querySelector('#dual-panels');
        const elTemplateInfoIcon = document.querySelector('[data-js="template-info-icon"]');
        const elInfoIcon = document.importNode(elTemplateInfoIcon.content, true);
        elDualPanels.replaceOpenIcon(elInfoIcon);
        const elTemplateCloseIcon = document.querySelector('[data-js="template-close-icon"]');
        const elCloseIcon = document.importNode(elTemplateCloseIcon.content, true);
        elDualPanels.replaceCloseIcon(elCloseIcon);

        // Create Pie and attach it with a timer to the animator
        const elPie = document.createElement('pie-cmpt');
        elDualPanels.populateMain(elPie);
        elPie.setPathClickEvent(ComponentStartPause.Event); // click Pie's path == click Start/Pause
        const timer = new Timer();
        const animator = new Animator(elPie, timer);

        // Initialise the Custom Duration modal
        const elModalDuration = document.querySelector('[data-js="picker-duration"]');
        const modalDuration = new Modal(elModalDuration);

        // Initialise the Controls
        const elSelectDuration = document.querySelector('[data-js="select-duration"]');
        const controls = new Controls(document, animator, elPie, timer, elSelectDuration, modalDuration);

        // On success close of Duration Modal update controls
        document.addEventListener(
            ComponentDuration.eventSuccessName,
            e => {
                const customDuration = e.detail.duration;
                modalDuration.close();
                controls.SetCustomDuration(customDuration);
            },
            false
        );

        // Add a wrapper for Info Panel to Dual Panels
        const elInfoContent = document.createElement('div');
        elDualPanels.populateSecond(elInfoContent);

        // Callback fn to update info elements of same name
        const infoCalculator = (() => {
            return {
                laps: () => {
                    return timer.laps;
                },
                time: () => {
                    return timer.getElapsedTimeInSeconds();
                },
                total: () => {
                    return timer.getTotalTimeInSeconds();
                },
            };
        })();

        const infoPanel = new InfoPanel(elInfoContent, infoCalculator);
        let hInfoTimer = window.setInterval(function() {
            // Refactor to function. This will then also be called by Pie complete event.
            infoPanel.update();
            infoPanel.render();
        }, 100);

        // Helper nodeIsChild
        function nodeIsChild(obj, parentSelector) {
            while (obj !== undefined && obj !== null && obj.tagName.toUpperCase() != 'BODY') {
                if (obj.matches(parentSelector)) {
                    return true;
                }
                obj = obj.parentNode;
            }
            return false;
        }
    </script>
</html>
